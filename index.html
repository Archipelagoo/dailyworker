<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen Online Daily Worker</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&amp;family=Bebas+Neue&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Poppins', sans-serif;
    }
    
    .time-display {
      font-family: 'Bebas Neue', sans-serif;
    }
    
    .header-logo {
      height: 40px;
      margin-right: 12px;
      filter: brightness(0) invert(1);
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* Workers Grid System */
    .workers-full-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 10px;
      margin-bottom: 24px;
    }
    
    /* Worker Card */
    .worker-item {
      display: flex;
      flex-direction: row;
      gap: 8px;
      padding: 10px;
      border-radius: 15px;
      background: white;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .worker-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    /* Left Side - Photo & Name */
    .worker-left-section {
      width: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .worker-avatar {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      overflow: hidden;
      background: linear-gradient(135deg, #ff8c00, #ff1493);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .worker-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .worker-initials {
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    
    .worker-fullname {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      color: #1e293b;
      text-align: center;
      line-height: 1.2;
    }
    
    /* Right Side - Status & Buttons */
    .worker-right-section {
      width: 50%;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .worker-status-box {
      background: #f1f5f9;
      padding: 5px;
      border-radius: 8px;
      text-align: center;
    }
    
    .status-label {
      font-size: 9px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
    }
    
    .status-time {
      font-size: 11px;
      font-weight: 700;
      color: #1e293b;
      margin-top: 2px;
    }
    
    /* Button Grid */
    .worker-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }
    
    .status-action-btn {
      font-size: 8px;
      padding: 6px 2px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }
    
    .btn-start {
      background: #22c55e;
    }
    
    .btn-start:hover {
      background: #16a34a;
    }
    
    .btn-finish {
      background: #3b82f6;
    }
    
    .btn-finish:hover {
      background: #2563eb;
    }
    
    .btn-break {
      background: #f59e0b;
    }
    
    .btn-break:hover {
      background: #d97706;
    }
    
    .btn-resume {
      background: #8b5cf6;
    }
    
    .btn-resume:hover {
      background: #7c3aed;
    }
    
    .sticky-column {
      position: sticky;
      left: 0;
      background: #1e293b;
      z-index: 10;
    }
    
    .photo-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(255, 20, 147, 0.5);
      }
      50% {
        box-shadow: 0 0 30px rgba(255, 20, 147, 0.8);
      }
    }
    
    .worker-card.selected {
      animation: pulse-glow 2s infinite;
    }
    
    /* Status Selected - Pink Theme */
    .status-selected {
      background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%) !important;
      color: white !important;
      border: 3px solid #ffffff !important;
      box-shadow: 0 0 20px rgba(255, 20, 147, 0.8), 0 0 40px rgba(255, 20, 147, 0.4);
      transform: scale(1.03);
      transition: all 0.3s ease;
      animation: pink-pulse 2s infinite;
    }
    
    .status-selected .worker-fullname {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .status-selected .worker-status-box {
      background: rgba(255, 255, 255, 0.25) !important;
    }
    
    .status-selected .status-label {
      color: white !important;
      font-weight: 700;
    }
    
    .status-selected .status-time {
      color: #facc15 !important;
      font-weight: 800;
    }
    
    @keyframes pink-pulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(255, 20, 147, 0.8), 0 0 40px rgba(255, 20, 147, 0.4);
      }
      50% {
        box-shadow: 0 0 30px rgba(255, 20, 147, 1), 0 0 60px rgba(255, 20, 147, 0.6);
      }
    }
    
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fade-in {
      animation: fade-in 0.6s ease-out;
    }
    
    /* Photo Gallery Styles */
    .photo-thumbnail-container {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .photo-thumbnail-container:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
    }
    
    .photo-thumbnail-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Lightbox Modal */
    .lightbox-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .lightbox-modal.active {
      display: flex;
    }
    
    .lightbox-content {
      max-width: 90%;
      max-height: 90vh;
      position: relative;
    }
    
    .lightbox-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .lightbox-close {
      position: absolute;
      top: -50px;
      right: 0;
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .lightbox-close:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-50%) scale(1.1);
    }
    
    .lightbox-nav.prev {
      left: -80px;
    }
    
    .lightbox-nav.next {
      right: -80px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full bg-[#0a1628] text-white overflow-auto"><!-- HEADER (Hidden on Login Page) -->
  <header id="main-header" class="sticky top-0 bg-[#1a2d4a] shadow-lg z-50 hidden">
   <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <div class="flex items-center"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w400" alt="Logo" class="header-logo" onerror="this.style.display='none';">
     <h1 id="header-title" class="text-xl md:text-2xl font-bold uppercase">ABSEN ONLINE DAILY WORKER</h1>
    </div>
    <div class="text-right">
     <div id="current-date" class="text-sm md:text-base text-white"></div>
     <div id="current-time" class="text-2xl md:text-4xl font-bold text-[#facc15] time-display"></div>
    </div>
   </div>
  </header><!-- PAGE: LOGIN -->
  <div id="page-login" class="page active bg-[#0a1628]" style="min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; padding: 1rem;">
   <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 w-full max-w-md animate-fade-in"><!-- Logo -->
    <div class="flex justify-center mb-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w400" alt="Logo" class="h-28 object-contain" style="border-radius: 12px;" onerror="this.style.display='none';">
    </div><!-- Title -->
    <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">ARCHIPELAGO ABSEN</h2>
    <div class="space-y-4">
     <div><label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Username</label> <input type="text" id="username" class="w-full px-4 py-3 bg-slate-100 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition">
     </div>
     <div><label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label> <input type="password" id="password" class="w-full px-4 py-3 bg-slate-100 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition">
     </div><button id="btn-login" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 transition duration-300 transform hover:scale-[1.02]"> LOGIN </button>
     <div id="login-error" class="text-red-600 text-sm text-center hidden"></div><!-- Setup Link -->
     <div class="text-center mt-4"><button id="btn-to-setup" class="text-xs text-gray-500 underline hover:text-gray-700 cursor-pointer">‚öôÔ∏è Setup Apps Script</button>
     </div>
    </div>
   </div>
  </div><!-- PAGE: ATTENDANCE -->
  <div id="page-attendance" class="page container mx-auto px-4 py-6">
   <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-2"><button id="btn-hadir-semua" class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg text-xs transition"> Hadir Semua </button> <button id="btn-reset" class="bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg text-xs transition"> Reset </button>
    </div><button id="btn-to-recap" class="bg-[#ff8c00] hover:bg-[#e67e00] px-6 py-2 rounded-lg font-semibold transition"> Lihat Recap </button>
   </div><!-- Grid Pekerja -->
   <div id="workers-grid" class="workers-full-grid"><!-- Worker cards will be generated here -->
   </div><!-- Upload Foto Absen Card -->
   <div class="bg-[#1e293b] border border-slate-700 rounded-2xl p-6 mt-8">
    <div class="flex items-center justify-between mb-4">
     <div>
      <h3 class="text-2xl font-bold text-white">üì∏ Upload Foto Absen</h3>
      <p class="text-sm text-gray-400 mt-1">(Max 10 Foto)</p>
     </div><button id="btn-ambil-foto" class="bg-gradient-to-r from-[#22c55e] to-[#16a34a] hover:opacity-90 text-white font-bold px-8 py-4 rounded-xl text-lg transition transform hover:scale-105 shadow-lg shadow-green-500/30"> üì∑ Ambil Foto </button>
    </div><!-- Photo Gallery Grid -->
    <div id="photo-gallery" class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6"><!-- Photo thumbnails will appear here -->
    </div>
   </div><!-- Hidden Camera Input --> <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;"> <!-- Hidden Canvas for Watermark Processing -->
   <canvas id="watermark-canvas" style="display: none;"></canvas><!-- Tombol Kirim Absen -->
   <div class="mt-6"><button id="btn-kirim-absen" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl text-xl transition transform hover:scale-[1.02] shadow-lg shadow-green-500/30 flex items-center justify-center gap-3">
     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
     </svg><span>KIRIM ABSEN</span> </button> <!-- Status Pengiriman -->
    <div id="send-status" class="hidden mt-4 p-4 rounded-lg"></div>
   </div>
  </div><!-- PAGE: RECAP MENU -->
  <div id="page-recap" class="page container mx-auto px-4 py-6"><button id="btn-back-from-recap" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold mb-6 transition"> ‚Üê Kembali </button>
   <h2 class="text-3xl font-bold mb-8 text-center">Menu Laporan</h2>
   <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto"><button id="btn-recap-today" class="bg-[#1e293b] hover:bg-[#2d3f5b] border-4 border-[#22c55e] rounded-2xl p-8 transition transform hover:scale-105">
     <div class="text-5xl mb-4">
      üìä
     </div><h3 class="text-2xl font-bold">Recap Hari Ini</h3><p class="text-gray-400 mt-2">Lihat absensi hari ini</p></button> <button id="btn-recap-date" class="bg-[#1e293b] hover:bg-[#2d3f5b] border-4 border-[#3b82f6] rounded-2xl p-8 transition transform hover:scale-105">
     <div class="text-5xl mb-4">
      üìÖ
     </div><h3 class="text-2xl font-bold">Pilih Tanggal</h3><p class="text-gray-400 mt-2">Pilih tanggal spesifik</p></button> <button id="btn-recap-jam" class="bg-[#06b6d4] hover:bg-[#0891b2] border-4 border-[#06b6d4] rounded-2xl p-8 transition transform hover:scale-105">
     <div class="text-5xl mb-4">
      ‚è±Ô∏è
     </div><h3 class="text-2xl font-bold">Total Jam Kerja</h3><p class="text-gray-400 mt-2">Hitung jam kerja pekerja</p></button>
   </div>
  </div><!-- PAGE: RECAP DETAIL (Table) -->
  <div id="page-recap-detail" class="page container mx-auto px-4 py-6">
   <div class="flex justify-between items-center mb-6"><button id="btn-back-from-detail" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition"> ‚Üê Kembali </button>
    <div><input type="date" id="date-picker" class="bg-[#1e293b] border border-[#334155] px-4 py-2 rounded-lg">
    </div>
   </div>
   <h2 class="text-2xl font-bold mb-4">Tabel Absensi</h2>
   <div class="bg-[#1e293b] rounded-xl overflow-x-auto">
    <table class="w-full text-sm">
     <thead>
      <tr class="bg-[#1e3a5f] text-[#facc15]">
       <th class="sticky-column px-4 py-3 text-left font-bold">Nama</th>
       <th class="px-4 py-3 font-bold">00:00</th>
       <th class="px-4 py-3 font-bold">01:00</th>
       <th class="px-4 py-3 font-bold">02:00</th>
       <th class="px-4 py-3 font-bold">03:00</th>
       <th class="px-4 py-3 font-bold">04:00</th>
       <th class="px-4 py-3 font-bold">05:00</th>
       <th class="px-4 py-3 font-bold">06:00</th>
       <th class="px-4 py-3 font-bold">07:00</th>
       <th class="px-4 py-3 font-bold">08:00</th>
       <th class="px-4 py-3 font-bold">09:00</th>
       <th class="px-4 py-3 font-bold">10:00</th>
       <th class="px-4 py-3 font-bold">11:00</th>
       <th class="px-4 py-3 font-bold">12:00</th>
       <th class="px-4 py-3 font-bold">13:00</th>
       <th class="px-4 py-3 font-bold">14:00</th>
       <th class="px-4 py-3 font-bold">15:00</th>
       <th class="px-4 py-3 font-bold">16:00</th>
       <th class="px-4 py-3 font-bold">17:00</th>
       <th class="px-4 py-3 font-bold">18:00</th>
       <th class="px-4 py-3 font-bold">19:00</th>
       <th class="px-4 py-3 font-bold">20:00</th>
       <th class="px-4 py-3 font-bold">21:00</th>
       <th class="px-4 py-3 font-bold">22:00</th>
       <th class="px-4 py-3 font-bold">23:00</th>
      </tr>
     </thead>
     <tbody id="recap-table-body"><!-- Table rows will be generated here -->
     </tbody>
    </table>
   </div>
  </div><!-- PAGE: RECAP JAM (Work Hours Calculator) -->
  <div id="page-recap-jam" class="page container mx-auto px-4 py-6"><button id="btn-back-from-jam" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold mb-6 transition"> ‚Üê Kembali </button>
   <h2 class="text-2xl font-bold mb-6">Hitung Total Jam Kerja</h2>
   <div class="mb-6"><input type="text" id="search-worker" placeholder="Cari nama pekerja..." class="w-full bg-[#1e293b] border border-[#334155] px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff1493]">
   </div>
   <div id="worker-result" class="hidden"><!-- Worker profile card -->
    <div class="bg-[#1e293b] rounded-xl p-6 mb-6">
     <div class="flex items-center gap-4"><img id="result-worker-photo" src="" alt="Photo" class="w-24 h-24 rounded-full object-cover">
      <div>
       <h3 id="result-worker-name" class="text-2xl font-bold"></h3>
       <p class="text-gray-400">Total Jam Kerja: <span id="total-hours" class="text-[#22c55e] font-bold text-xl">0</span> jam</p>
      </div>
     </div>
    </div><!-- Work sessions list -->
    <div class="space-y-4" id="sessions-list"><!-- Sessions will be generated here -->
    </div>
   </div>
  </div><!-- PAGE: SETUP APPS SCRIPT -->
  <div id="page-setup" class="page container mx-auto px-4 py-6 max-w-4xl">
   <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">‚öôÔ∏è Setup Apps Script</h2><button id="btn-back-from-setup" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition"> ‚Üê Kembali </button>
   </div><!-- Step 1: Apps Script Code -->
   <div class="bg-[#1e293b] border border-[#334155] rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
     <div class="bg-[#22c55e] text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">
      1
     </div>
     <h3 class="text-xl font-bold">Copy Kode Apps Script</h3>
    </div>
    <p class="text-gray-300 mb-4">Copy kode di bawah ini dan paste ke Google Apps Script Editor:</p>
    <div class="bg-[#0f172a] rounded-xl p-4 relative"><button id="btn-copy-script" class="absolute top-4 right-4 bg-[#3b82f6] hover:bg-[#2563eb] text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2"> <span>üìã</span> <span id="copy-text">Copy</span> </button>
     <pre id="apps-script-code" class="text-sm text-gray-300 overflow-x-auto pr-24" style="max-height: 600px;"><code>// Spreadsheet ID dari URL Anda
const SPREADSHEET_ID = '1ktMqdAoIOrBT6ViqGWwJRRZpjuB6I4nPOkSPeziMyDY';

// Drive Folder ID untuk menyimpan foto
const DRIVE_FOLDER_ID = '1CJ46h8M89mzc3XKEg-4hJPV-2voMN3OD';

function doGet(e) {
  const action = e.parameter.action;
  
  if (action === 'getWorkers') {
    return getWorkers();
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'error',
    message: 'Invalid action'
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (!data.tanggal || !data.jam || !data.workers) {
      throw new Error('Data tidak lengkap');
    }
    
    // Submit attendance
    submitAttendance(data);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      message: 'Absensi berhasil dikirim'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getWorkers() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('Workers');
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'error',
        message: 'Sheet "Workers" tidak ditemukan'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    const workers = rows.map(row =&gt; {
      return {
        name: row[1],
        photo: row[2]
      };
    });
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: workers
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function submitAttendance(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('Attendance');
  
  // Create sheet if not exists
  if (!sheet) {
    sheet = ss.insertSheet('Attendance');
  }
  
  // Parse tanggal
  const dateParts = data.tanggal.split('/');
  const day = parseInt(dateParts[0]);
  const month = parseInt(dateParts[1]);
  const year = parseInt(dateParts[2]);
  
  // Determine row color based on odd/even date
  const dateColor = (day % 2 === 1) ? '#cccccc' : '#ffffff';
  
  // Find or create column for this date
  const lastColumn = sheet.getLastColumn();
  let targetColumn = -1;
  
  // Check if date already exists
  if (lastColumn &gt; 0) {
    const firstRow = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
    for (let i = 0; i &lt; firstRow.length; i++) {
      if (firstRow[i] == data.tanggal) {
        targetColumn = i + 1;
        break;
      }
    }
  }
  
  // Create new column if date doesn't exist
  if (targetColumn === -1) {
    targetColumn = lastColumn + 1;
    
    // Set date (row 1)
    const dateCell = sheet.getRange(1, targetColumn);
    dateCell.setValue(data.tanggal);
    dateCell.setBackground(dateColor);
    dateCell.setFontWeight('bold');
    dateCell.setHorizontalAlignment('center');
    
    // Set time (row 2)
    const timeCell = sheet.getRange(2, targetColumn);
    timeCell.setValue(data.jam);
    timeCell.setBackground('#f3f3f3');
    timeCell.setHorizontalAlignment('center');
  } else {
    // Update time in existing column
    sheet.getRange(2, targetColumn).setValue(data.jam);
  }
  
  // Write worker data starting from row 3
  data.workers.forEach((worker, index) =&gt; {
    const row = index + 3;
    
    // Set worker name in column A if not exists
    if (sheet.getRange(row, 1).getValue() === '') {
      sheet.getRange(row, 1).setValue(worker.name);
      sheet.getRange(row, 1).setFontWeight('bold');
    }
    
    // Set status with color
    const statusCell = sheet.getRange(row, targetColumn);
    statusCell.setValue(worker.status);
    statusCell.setHorizontalAlignment('center');
    
    // Apply color based on status
    let bgColor = '#ffffff';
    switch (worker.color) {
      case 'green':
        bgColor = '#00ff00';
        break;
      case 'blue':
        bgColor = '#0000ff';
        break;
      case 'orange':
        bgColor = '#ffa500';
        break;
      case 'purple':
        bgColor = '#800080';
        break;
      case 'red':
        bgColor = '#ff0000';
        break;
    }
    
    statusCell.setBackground(bgColor);
    
    // Set text color to white for better readability
    if (worker.color !== 'white') {
      statusCell.setFontColor('#ffffff');
      statusCell.setFontWeight('bold');
    }
  });
  
  // Upload photos to Drive
  if (data.photos &amp;&amp; data.photos.length &gt; 0) {
    uploadPhotosToDrive(data.photos, data.tanggal);
  }
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, targetColumn);
}

function uploadPhotosToDrive(photos, tanggal) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    // Create or get subfolder with date
    const folderName = tanggal.replace(/\//g, '-');
    let dateFolder;
    
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      dateFolder = folders.next();
    } else {
      dateFolder = parentFolder.createFolder(folderName);
    }
    
    // Upload each photo
    photos.forEach((photoBase64, index) =&gt; {
      try {
        // Remove data URL prefix
        const base64Data = photoBase64.split(',')[1];
        
        // Decode base64
        const blob = Utilities.newBlob(
          Utilities.base64Decode(base64Data),
          'image/jpeg',
          `Absen_${index + 1}_${new Date().getTime()}.jpg`
        );
        
        // Save to folder
        dateFolder.createFile(blob);
        
      } catch (photoError) {
        Logger.log('Error uploading photo ' + index + ': ' + photoError.toString());
      }
    });
    
    Logger.log('Successfully uploaded ' + photos.length + ' photos to folder: ' + folderName);
    
  } catch (error) {
    Logger.log('Error in uploadPhotosToDrive: ' + error.toString());
  }
}</code></pre>
    </div>
    <div class="mt-4 bg-[#0f172a] border border-[#facc15] rounded-lg p-4">
     <p class="text-[#facc15] font-semibold mb-2">üí° Petunjuk:</p>
     <ul class="text-sm text-gray-300 space-y-1 list-disc list-inside">
      <li>Buka Google Sheets Anda</li>
      <li>Klik <strong>Extensions ‚Üí Apps Script</strong></li>
      <li>Hapus kode default, paste kode di atas</li>
      <li>Klik <strong>Deploy ‚Üí New deployment</strong></li>
      <li>Pilih type: <strong>Web app</strong></li>
      <li>Execute as: <strong>Me</strong></li>
      <li>Who has access: <strong>Anyone</strong></li>
      <li>Copy URL yang muncul</li>
     </ul>
    </div>
   </div><!-- Step 2: Sheet Format -->
   <div class="bg-[#1e293b] border border-[#334155] rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
     <div class="bg-[#ff8c00] text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">
      2
     </div>
     <h3 class="text-xl font-bold">Format Google Sheets</h3>
    </div>
    <p class="text-gray-300 mb-4">Pastikan Sheet bernama <strong>"Workers"</strong> dengan format:</p>
    <div class="bg-[#0f172a] rounded-xl p-4 overflow-x-auto">
     <table class="w-full text-sm">
      <thead>
       <tr class="border-b border-gray-600">
        <th class="px-4 py-2 text-left text-[#22c55e]">A</th>
        <th class="px-4 py-2 text-left text-[#22c55e]">B</th>
        <th class="px-4 py-2 text-left text-[#22c55e]">C</th>
       </tr>
      </thead>
      <tbody>
       <tr class="border-b border-gray-700">
        <td class="px-4 py-2 text-[#facc15] font-bold">id</td>
        <td class="px-4 py-2 text-[#facc15] font-bold">name</td>
        <td class="px-4 py-2 text-[#facc15] font-bold">photo</td>
       </tr>
       <tr class="border-b border-gray-700">
        <td class="px-4 py-2">1</td>
        <td class="px-4 py-2">John Doe</td>
        <td class="px-4 py-2 text-xs">https://drive.google.com/file/d/...</td>
       </tr>
       <tr class="border-b border-gray-700">
        <td class="px-4 py-2">2</td>
        <td class="px-4 py-2">Jane Smith</td>
        <td class="px-4 py-2 text-xs">https://drive.google.com/file/d/...</td>
       </tr>
      </tbody>
     </table>
    </div>
    <div class="mt-4 bg-[#0f172a] border border-[#3b82f6] rounded-lg p-4">
     <p class="text-[#3b82f6] font-semibold mb-2">üìå Catatan:</p>
     <ul class="text-sm text-gray-300 space-y-1 list-disc list-inside">
      <li>Kolom A: <strong>id</strong> (nomor urut pekerja)</li>
      <li>Kolom B: <strong>name</strong> (nama pekerja)</li>
      <li>Kolom C: <strong>photo</strong> (link Google Drive foto)</li>
      <li>Row 1 HARUS header: <strong>id | name | photo</strong></li>
      <li>Sheet HARUS bernama <strong>"Workers"</strong> (huruf W besar)</li>
     </ul>
    </div>
   </div><!-- Step 3: Paste URL -->
   <div class="bg-[#1e293b] border border-[#334155] rounded-2xl p-6">
    <div class="flex items-center gap-3 mb-4">
     <div class="bg-[#ff1493] text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg">
      3
     </div>
     <h3 class="text-xl font-bold">Paste URL Apps Script</h3>
    </div>
    <p class="text-gray-300 mb-4">Paste URL deployment dari Apps Script Anda:</p>
    <div class="mb-4"><label class="block text-sm font-semibold text-gray-300 mb-2">Apps Script URL:</label> <input type="text" id="apps-script-url" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" class="w-full bg-[#0f172a] border border-[#334155] px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff1493] text-white">
    </div><button id="btn-save-url" class="w-full bg-gradient-to-r from-[#ff8c00] to-[#ff1493] hover:opacity-90 text-white font-bold py-4 rounded-xl text-lg transition"> üíæ SIMPAN &amp; TEST KONEKSI </button>
    <div id="test-result" class="mt-4 hidden"></div>
   </div>
  </div><!-- Lightbox Modal -->
  <div id="lightbox-modal" class="lightbox-modal">
   <div class="lightbox-content"><button class="lightbox-close" id="lightbox-close">‚úï Close</button> <button class="lightbox-nav prev" id="lightbox-prev">‚Äπ</button> <img id="lightbox-image" src="" alt="Full size photo"> <button class="lightbox-nav next" id="lightbox-next">‚Ä∫</button>
   </div>
  </div>
  <script>
    // Config
    const defaultConfig = {
      app_title: 'ABSEN ONLINE DAILY WORKER',
      login_username: 'archipelago',
      login_password: 'balivibes'
    };

    // Workers data (will be loaded from Google Sheets)
    let workers = [];
    let appsScriptUrl = localStorage.getItem('appsScriptUrl') || 'https://script.google.com/macros/s/AKfycby8PVX_YKlSsKVVjUUERHoq52cl-jj9VHsCmcb5WOmaSmjvRsChZipnlBQccbDhbV9L/exec';

    // Convert Google Drive link to direct image link
    function convertDriveLink(url) {
      if (!url || url.trim() === '') return '';
      
      if (url.includes('drive.google.com')) {
        let fileId = '';
        
        if (url.includes('/file/d/')) {
          fileId = url.split('/file/d/')[1].split('/')[0];
        }
        else if (url.includes('open?id=')) {
          fileId = url.split('open?id=')[1].split('&')[0];
        }
        else if (url.includes('uc?id=')) {
          fileId = url.split('uc?id=')[1].split('&')[0];
        }
        else if (url.includes('id=')) {
          fileId = url.split('id=')[1].split('&')[0];
        }
        
        if (fileId) {
          return `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
        }
      }
      
      return url;
    }

    // Get initials from name for placeholder
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name[0].toUpperCase();
    }

    // Load workers from cache instantly
    function loadCachedWorkers() {
      try {
        const cached = localStorage.getItem('cached_workers');
        if (cached) {
          const cachedData = JSON.parse(cached);
          workers = cachedData;
          generateWorkerCards();
          return true;
        }
      } catch (error) {
        console.error('Error loading cache:', error);
      }
      return false;
    }

    // Save workers to cache
    function saveWorkersToCache(workersData) {
      try {
        localStorage.setItem('cached_workers', JSON.stringify(workersData));
      } catch (error) {
        console.error('Error saving cache:', error);
      }
    }

    // Fetch workers data from Google Sheets (silent background update)
    async function fetchWorkers(silent = false) {
      if (!silent) {
        const grid = document.getElementById('workers-grid');
        grid.innerHTML = '<div class="col-span-full text-center text-gray-400">‚è≥ Memuat data pekerja...</div>';
      }
      
      try {
        console.log('Fetching workers data from:', appsScriptUrl);
        const response = await fetch(`${appsScriptUrl}?action=getWorkers`);
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.status === 'success' && data.data && Array.isArray(data.data)) {
          console.log('Workers count:', data.data.length);
          
          const newWorkers = data.data.map((worker, index) => ({
            id: index + 1,
            name: worker.name || 'Unnamed Worker',
            photo: convertDriveLink(worker.photo) || '',
            initials: getInitials(worker.name || 'Unnamed Worker')
          }));
          
          console.log('Workers mapped:', newWorkers);
          
          // Save to cache
          saveWorkersToCache(newWorkers);
          
          // Update workers array
          workers = newWorkers;
          
          // Generate worker cards
          generateWorkerCards();
          
          if (!silent) {
            showToast(`‚úÖ ${workers.length} pekerja berhasil dimuat`);
          }
        } else {
          console.error('Invalid data format:', data);
          if (!silent) {
            const grid = document.getElementById('workers-grid');
            grid.innerHTML = '<div class="col-span-full text-center text-red-400">‚ùå Format data tidak valid.</div>';
            showToast('‚ùå Gagal memuat data pekerja');
          }
        }
      } catch (error) {
        console.error('Error fetching workers:', error);
        if (!silent) {
          const grid = document.getElementById('workers-grid');
          grid.innerHTML = `<div class="col-span-full text-center text-red-400">‚ùå Error: ${error.message}</div>`;
          showToast('‚ùå Tidak dapat terhubung ke server');
        }
      }
    }

    // Initialize app with instant cache loading
    function initApp() {
      const hasCachedData = loadCachedWorkers();
      
      if (hasCachedData) {
        console.log('‚úÖ Loaded from cache instantly');
        // Update from server in background (silent)
        fetchWorkers(true);
      } else {
        console.log('No cache found, fetching from server...');
        const grid = document.getElementById('workers-grid');
        grid.innerHTML = '<div class="col-span-full text-center text-gray-400">‚è≥ Memuat data pekerja...</div>';
        fetchWorkers(false);
      }
    }

    // State
    let selectedWorkers = new Set();
    let capturedPhotos = [];
    let currentLocation = { lat: null, lng: null };
    let attendanceData = {};
    let workSessions = {};
    let selectedCards = {}; // Track which cards are selected (pink state)
    let attendancePhotos = []; // Store photos with watermark
    let currentLightboxIndex = 0;

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      const header = document.getElementById('main-header');
      if (pageId === 'page-login' || pageId === 'page-setup') {
        header.classList.add('hidden');
      } else {
        header.classList.remove('hidden');
      }
    }

    // Real-time clock
    function updateClock() {
      const now = new Date();
      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      const dayName = days[now.getDay()];
      const date = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      document.getElementById('current-date').textContent = `${dayName}, ${date} ${month} ${year}`;
      document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds} WIB`;
    }

    // Generate worker cards
    function generateWorkerCards() {
      const grid = document.getElementById('workers-grid');
      grid.innerHTML = '';
      
      if (workers.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #94a3b8;">Memuat data pekerja...</div>';
        return;
      }
      
      workers.forEach(worker => {
        const card = document.createElement('div');
        
        // Add status-selected class if card is selected
        const isSelected = selectedCards[worker.id];
        card.className = isSelected ? 'worker-item status-selected' : 'worker-item';
        
        let photoHTML = '';
        if (worker.photo && worker.photo.trim() !== '') {
          const fallbackUrl = worker.photo.replace('/thumbnail?', '/uc?export=view&').replace('&sz=w400', '');
          
          photoHTML = `
            <div class="worker-avatar">
              <img src="${worker.photo}" 
                   alt="${worker.name}"
                   onerror="console.error('Failed to load image:', this.src); this.src='${fallbackUrl}'; this.onerror=function() { this.style.display='none'; this.parentElement.innerHTML='<div class=\\'worker-initials\\'>${worker.initials}</div>'; };">
            </div>
          `;
        } else {
          photoHTML = `
            <div class="worker-avatar">
              <div class="worker-initials">${worker.initials}</div>
            </div>
          `;
        }
        
        const sessions = workSessions[worker.id] || [];
        const lastSession = sessions[sessions.length - 1];
        const currentAction = selectedCards[worker.id];
        
        let statusText = 'Belum Dipilih';
        let statusTime = '';
        
        // Prioritize showing current selected action
        if (currentAction === 'start') {
          statusText = 'START WORK';
          statusTime = lastSession?.start || '';
        } else if (currentAction === 'finish') {
          statusText = 'SELESAI';
          statusTime = lastSession?.finish || '';
        } else if (currentAction === 'break') {
          statusText = 'ISTIRAHAT';
          statusTime = lastSession?.break || '';
        } else if (currentAction === 'resume') {
          statusText = 'LANJUT KERJA';
          statusTime = lastSession?.resume || '';
        } else if (lastSession) {
          // Fallback to session data if no selection
          if (lastSession.finish) {
            statusText = 'SELESAI';
            statusTime = lastSession.finish;
          } else if (lastSession.start) {
            statusText = 'BEKERJA';
            statusTime = lastSession.start;
          }
        }
        
        card.innerHTML = `
          <div class="worker-left-section">
            ${photoHTML}
            <div class="worker-fullname">${worker.name}</div>
          </div>
          
          <div class="worker-right-section">
            <div class="worker-status-box">
              <div class="status-label">${statusText}</div>
              <div class="status-time">${statusTime}</div>
            </div>
            
            <div class="worker-actions-grid">
              <button class="status-action-btn btn-start" data-id="${worker.id}">Start</button>
              <button class="status-action-btn btn-finish" data-id="${worker.id}">Finish</button>
              <button class="status-action-btn btn-break" data-id="${worker.id}">Break</button>
              <button class="status-action-btn btn-resume" data-id="${worker.id}">Resume</button>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      document.querySelectorAll('.btn-start').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const workerId = parseInt(btn.dataset.id);
          recordTime(workerId, 'start');
        });
      });
      
      document.querySelectorAll('.btn-finish').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const workerId = parseInt(btn.dataset.id);
          recordTime(workerId, 'finish');
        });
      });
      
      document.querySelectorAll('.btn-break').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const workerId = parseInt(btn.dataset.id);
          recordTime(workerId, 'break');
        });
      });
      
      document.querySelectorAll('.btn-resume').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const workerId = parseInt(btn.dataset.id);
          recordTime(workerId, 'resume');
        });
      });
    }

    // Record start/finish time with toggle functionality
    function recordTime(workerId, type) {
      const now = new Date();
      const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      if (!workSessions[workerId]) {
        workSessions[workerId] = [];
      }
      
      // Check if card is already selected with the same action
      const isCurrentlySelected = selectedCards[workerId] === type;
      
      if (isCurrentlySelected) {
        // UN-CLICK: Remove selection and revert status
        delete selectedCards[workerId];
        
        // Remove the last action from session
        const lastSession = workSessions[workerId][workSessions[workerId].length - 1];
        if (lastSession) {
          if (type === 'start' && lastSession.start && !lastSession.finish) {
            workSessions[workerId].pop();
          } else if (type === 'finish' && lastSession.finish) {
            lastSession.finish = null;
          } else if (type === 'break' && lastSession.break) {
            lastSession.break = null;
          } else if (type === 'resume' && lastSession.resume) {
            lastSession.resume = null;
          }
        }
        
        showToast(`üîÑ Status dibatalkan`);
      } else {
        // CLICK: Apply new status and select card
        selectedCards[workerId] = type;
        
        if (type === 'start') {
          workSessions[workerId].push({ start: timeString, finish: null, break: null, resume: null });
          showToast(`‚è∞ Start time: ${timeString}`);
        } else if (type === 'finish') {
          const lastSession = workSessions[workerId][workSessions[workerId].length - 1];
          if (lastSession && !lastSession.finish) {
            lastSession.finish = timeString;
            showToast(`‚úÖ Finish time: ${timeString}`);
          } else {
            workSessions[workerId].push({ start: null, finish: timeString, break: null, resume: null });
            showToast(`‚úÖ Finish time: ${timeString}`);
          }
        } else if (type === 'break') {
          const lastSession = workSessions[workerId][workSessions[workerId].length - 1];
          if (lastSession) {
            lastSession.break = timeString;
            showToast(`‚òï Break time: ${timeString}`);
          }
        } else if (type === 'resume') {
          const lastSession = workSessions[workerId][workSessions[workerId].length - 1];
          if (lastSession) {
            lastSession.resume = timeString;
            showToast(`‚ñ∂Ô∏è Resume time: ${timeString}`);
          }
        }
      }
      
      generateWorkerCards();
    }

    // Show toast notification
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 right-4 bg-[#22c55e] text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Setup page handlers
    document.getElementById('btn-to-setup').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('page-login').style.display = 'none';
      showPage('page-setup');
      if (appsScriptUrl) {
        document.getElementById('apps-script-url').value = appsScriptUrl;
      }
    });

    document.getElementById('btn-back-from-setup').addEventListener('click', () => {
      document.getElementById('page-login').style.display = 'flex';
      showPage('page-login');
    });

    // Copy script button
    document.getElementById('btn-copy-script').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const codeElement = document.querySelector('#apps-script-code code');
      const range = document.createRange();
      range.selectNodeContents(codeElement);
      
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      
      try {
        const successful = document.execCommand('copy');
        selection.removeAllRanges();
        
        if (successful) {
          const copyText = document.getElementById('copy-text');
          copyText.textContent = '‚úÖ Copied!';
          setTimeout(() => {
            copyText.textContent = 'Copy';
          }, 2000);
          showToast('‚úÖ Kode berhasil di-copy!');
        } else {
          showToast('‚ùå Gagal copy. Silakan copy manual.');
        }
      } catch (err) {
        console.error('Copy failed:', err);
        showToast('‚ùå Gagal copy. Silakan copy manual.');
      }
    });

    // Save and test URL
    document.getElementById('btn-save-url').addEventListener('click', async () => {
      const url = document.getElementById('apps-script-url').value.trim();
      const resultDiv = document.getElementById('test-result');
      
      if (!url) {
        resultDiv.className = 'mt-4 bg-red-500/20 border border-red-500 rounded-lg p-4';
        resultDiv.innerHTML = '<p class="text-red-400 font-semibold">‚ùå URL tidak boleh kosong!</p>';
        resultDiv.classList.remove('hidden');
        return;
      }
      
      resultDiv.className = 'mt-4 bg-blue-500/20 border border-blue-500 rounded-lg p-4';
      resultDiv.innerHTML = '<p class="text-blue-400 font-semibold">‚è≥ Testing koneksi...</p>';
      resultDiv.classList.remove('hidden');
      
      try {
        const response = await fetch(`${url}?action=getWorkers`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data) {
          appsScriptUrl = url;
          localStorage.setItem('appsScriptUrl', url);
          
          resultDiv.className = 'mt-4 bg-green-500/20 border border-green-500 rounded-lg p-4';
          resultDiv.innerHTML = `
            <p class="text-green-400 font-semibold mb-2">‚úÖ Koneksi berhasil!</p>
            <p class="text-sm text-gray-300">Berhasil memuat ${data.data.length} pekerja dari Google Sheets.</p>
          `;
          showToast(`‚úÖ URL tersimpan! ${data.data.length} pekerja terdeteksi`);
          
          setTimeout(() => {
            showPage('page-login');
          }, 2000);
        } else {
          resultDiv.className = 'mt-4 bg-red-500/20 border border-red-500 rounded-lg p-4';
          resultDiv.innerHTML = `
            <p class="text-red-400 font-semibold mb-2">‚ùå Koneksi gagal!</p>
            <p class="text-sm text-gray-300">Error: ${data.message || 'Format data tidak valid'}</p>
          `;
        }
      } catch (error) {
        resultDiv.className = 'mt-4 bg-red-500/20 border border-red-500 rounded-lg p-4';
        resultDiv.innerHTML = `
          <p class="text-red-400 font-semibold mb-2">‚ùå Tidak dapat terhubung!</p>
          <p class="text-sm text-gray-300">${error.message}</p>
          <p class="text-xs text-gray-400 mt-2">Pastikan Apps Script sudah di-deploy dengan benar.</p>
        `;
      }
    });

    // Login
    document.getElementById('btn-login').addEventListener('click', () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      
      if (username === config.login_username && password === config.login_password) {
        document.getElementById('page-login').style.display = 'none';
        showPage('page-attendance');
        
        // Initialize app with cache strategy
        initApp();
      } else {
        const errorDiv = document.getElementById('login-error');
        errorDiv.textContent = 'Username atau password salah!';
        errorDiv.classList.remove('hidden');
        
        setTimeout(() => {
          errorDiv.classList.add('hidden');
        }, 3000);
      }
    });

    // Navigation buttons
    document.getElementById('btn-to-recap').addEventListener('click', () => showPage('page-recap'));
    document.getElementById('btn-back-from-recap').addEventListener('click', () => showPage('page-attendance'));
    document.getElementById('btn-back-from-detail').addEventListener('click', () => showPage('page-recap'));
    document.getElementById('btn-back-from-jam').addEventListener('click', () => showPage('page-recap'));
    
    // Hadir Semua button
    document.getElementById('btn-hadir-semua').addEventListener('click', () => {
      const now = new Date();
      const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      workers.forEach(worker => {
        if (!workSessions[worker.id]) {
          workSessions[worker.id] = [];
        }
        workSessions[worker.id].push({ start: timeString, finish: null, break: null, resume: null });
      });
      
      generateWorkerCards();
      showToast(`‚úÖ Semua pekerja ditandai hadir pada ${timeString}`);
    });
    
    // Reset button
    document.getElementById('btn-reset').addEventListener('click', () => {
      workSessions = {};
      selectedCards = {}; // Reset pink selections
      generateWorkerCards();
      showToast('üîÑ Semua status direset');
    });
    
    document.getElementById('btn-recap-today').addEventListener('click', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-picker').value = today;
      generateRecapTable(today);
      showPage('page-recap-detail');
    });
    
    document.getElementById('btn-recap-date').addEventListener('click', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-picker').value = today;
      generateRecapTable(today);
      showPage('page-recap-detail');
    });
    
    document.getElementById('btn-recap-jam').addEventListener('click', () => showPage('page-recap-jam'));
    
    document.getElementById('date-picker').addEventListener('change', (e) => {
      generateRecapTable(e.target.value);
    });

    // Generate recap table
    function generateRecapTable(date) {
      const tbody = document.getElementById('recap-table-body');
      tbody.innerHTML = '';
      
      workers.forEach(worker => {
        const row = document.createElement('tr');
        row.className = 'border-b border-[#334155]';
        
        let html = `<td class="sticky-column px-4 py-3 font-semibold">${worker.name}</td>`;
        
        for (let hour = 0; hour < 24; hour++) {
          const hasData = Math.random() > 0.7;
          const cellClass = hasData ? 'bg-[#22c55e]' : 'bg-[#1e293b]';
          html += `<td class="${cellClass} px-4 py-3 text-center">-</td>`;
        }
        
        row.innerHTML = html;
        tbody.appendChild(row);
      });
    }

    // Calculate work hours
    function calculateWorkHours(sessions) {
      let totalMinutes = 0;
      
      sessions.forEach(session => {
        if (!session.start || !session.finish) return;
        
        const startTime = session.start.replace('.', ':');
        const finishTime = session.finish.replace('.', ':');
        
        const [startHour, startMin] = startTime.split(':').map(Number);
        const [finishHour, finishMin] = finishTime.split(':').map(Number);
        
        let startTotalMin = startHour * 60 + startMin;
        let finishTotalMin = finishHour * 60 + finishMin;
        
        if (finishTotalMin < startTotalMin) {
          finishTotalMin += 1440;
        }
        
        const duration = finishTotalMin - startTotalMin;
        if (!isNaN(duration) && duration > 0) {
          totalMinutes += duration;
        }
      });
      
      return (totalMinutes / 60).toFixed(2);
    }

    // Search worker and calculate hours
    document.getElementById('search-worker').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const worker = workers.find(w => w.name.toLowerCase().includes(searchTerm));
      
      if (worker && searchTerm.length > 2) {
        document.getElementById('worker-result').classList.remove('hidden');
        document.getElementById('result-worker-photo').textContent = worker.photo;
        document.getElementById('result-worker-name').textContent = worker.name;
        
        const sessions = workSessions[worker.id] || [];
        const totalHours = calculateWorkHours(sessions);
        document.getElementById('total-hours').textContent = totalHours;
        
        const sessionsList = document.getElementById('sessions-list');
        sessionsList.innerHTML = '';
        
        sessions.forEach((session, index) => {
          const div = document.createElement('div');
          div.className = 'bg-[#1e293b] rounded-lg p-4';
          div.innerHTML = `
            <h4 class="font-bold mb-2">Sesi ${index + 1}</h4>
            <div class="flex justify-between text-sm">
              <span>Start: <span class="text-[#22c55e] font-semibold">${session.start || '-'}</span></span>
              <span>Finish: <span class="text-[#3b82f6] font-semibold">${session.finish || '-'}</span></span>
            </div>
          `;
          sessionsList.appendChild(div);
        });
      } else {
        document.getElementById('worker-result').classList.add('hidden');
      }
    });

    // Initialize
    updateClock();
    setInterval(updateClock, 1000);

    // Get current location
    function getCurrentLocation() {
      return new Promise((resolve) => {
        // Skip geolocation in iframe environment (permissions policy block)
        // Always return null coordinates
        resolve({ lat: null, lng: null });
      });
    }

    // Reverse geocoding to get address from coordinates
    async function getAddressFromCoords(lat, lng) {
      if (!lat || !lng) return 'Lokasi tidak tersedia';
      
      try {
        // Using OpenStreetMap Nominatim API (free, no API key needed)
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
        const data = await response.json();
        
        if (data && data.display_name) {
          // Extract relevant parts of address
          const address = data.address;
          const parts = [];
          
          if (address.road) parts.push(address.road);
          if (address.suburb || address.village) parts.push(address.suburb || address.village);
          if (address.city || address.town) parts.push(address.city || address.town);
          
          return parts.length > 0 ? parts.join(', ') : data.display_name.substring(0, 50);
        }
      } catch (error) {
        console.error('Geocoding error:', error);
      }
      
      return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }

    // Load company logo image with direct download link
    const companyLogoFileId = '1zaavYZSem-yNHztE724qeIAWw9uGJgen';
    const companyLogoUrl = `https://drive.google.com/uc?export=download&id=${companyLogoFileId}`;
    
    const companyLogo = new Image();
    companyLogo.crossOrigin = 'anonymous';
    
    let companyLogoLoaded = false;
    
    // Add success handler
    companyLogo.onload = () => {
      console.log('‚úÖ Company logo loaded successfully!');
      companyLogoLoaded = true;
    };
    
    // Add error handling for logo
    companyLogo.onerror = () => {
      console.warn('‚ö†Ô∏è Company logo failed to load, trying alternative URL');
      companyLogoLoaded = false;
      // Try alternative URL
      companyLogo.src = `https://lh3.googleusercontent.com/d/${companyLogoFileId}`;
    };
    
    // Start loading
    companyLogo.src = companyLogoUrl;

    // Add watermark to photo with HIGH RESOLUTION and AUTO RESIZE
    async function addWatermarkToPhoto(imageDataUrl) {
      return new Promise(async (resolve) => {
        const img = new Image();
        img.onload = async () => {
          const canvas = document.getElementById('watermark-canvas');
          const ctx = canvas.getContext('2d');
          
          // Determine orientation: Portrait or Landscape
          const isPortrait = img.height > img.width;
          
          // Target dimensions based on orientation
          let targetWidth, targetHeight;
          if (isPortrait) {
            targetWidth = 1080;
            targetHeight = 1920;
          } else {
            targetWidth = 1920;
            targetHeight = 1080;
          }
          
          // Calculate aspect ratios
          const sourceRatio = img.width / img.height;
          const targetRatio = targetWidth / targetHeight;
          
          // Calculate crop dimensions to maintain aspect ratio (cover fit)
          let sourceX = 0, sourceY = 0, sourceWidth = img.width, sourceHeight = img.height;
          
          if (sourceRatio > targetRatio) {
            // Source is wider, crop width
            sourceWidth = img.height * targetRatio;
            sourceX = (img.width - sourceWidth) / 2;
          } else {
            // Source is taller, crop height
            sourceHeight = img.width / targetRatio;
            sourceY = (img.height - sourceHeight) / 2;
          }
          
          // Set canvas to target high-resolution dimensions
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          
          // Enable high-quality image smoothing
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          
          // Draw cropped and resized image at target resolution
          ctx.drawImage(
            img,
            sourceX, sourceY, sourceWidth, sourceHeight,  // Source crop
            0, 0, targetWidth, targetHeight               // Destination size
          );
          
          // Calculate responsive sizes - SMALLER for landscape, normal for portrait
          const sizeMultiplier = isPortrait ? 1.0 : 0.5; // 50% smaller for landscape
          const baseFontSize = canvas.width * 0.03 * sizeMultiplier; // Base font
          const largeFontSize = canvas.width * 0.045 * sizeMultiplier; // Large font
          const padding = canvas.width * 0.04 * sizeMultiplier; // Padding
          const lineHeight = canvas.width * 0.055 * sizeMultiplier; // Line height
          
          // Get current date and time
          const now = new Date();
          const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
          const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
          
          const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          const dayName = days[now.getDay()];
          const dateString = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
          
          // Get location (will be null in iframe)
          const location = await getCurrentLocation();
          const address = await getAddressFromCoords(location.lat, location.lng);
          
          // === TOP RIGHT WATERMARK: TimeMark (3X LARGER) ===
          ctx.textAlign = 'right';
          ctx.textBaseline = 'top';
          
          // Strong shadow for readability on white background
          ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
          ctx.shadowBlur = 15;
          ctx.shadowOffsetX = 5;
          ctx.shadowOffsetY = 5;
          
          // "TimeMark" - 3X larger
          ctx.font = `bold ${largeFontSize * 2}px 'Bebas Neue', sans-serif`;
          
          // Measure "Mark" width first
          const markWidth = ctx.measureText('Mark').width;
          
          // Draw "Mark" in white
          ctx.fillStyle = '#ffffff';
          ctx.fillText('Mark', canvas.width - padding, padding);
          
          // Draw "Time" in yellow before "Mark"
          ctx.fillStyle = '#facc15';
          ctx.fillText('Time', canvas.width - padding - markWidth, padding);
          
          // "100% photo verified" - same width as TimeMark, 3X larger
          ctx.font = `700 ${baseFontSize * 1.3}px 'Poppins', sans-serif`;
          ctx.fillStyle = '#ffffff';
          ctx.fillText('100% photo verified', canvas.width - padding, padding + (largeFontSize * 2.2));
          
          // === BOTTOM LEFT WATERMARK (3 Baris - 3X LARGER) ===
          
          // Calculate sizes - adjust based on orientation
          const logoSize = canvas.width * 0.16 * sizeMultiplier; // Smaller for landscape
          const logoCardPadding = canvas.width * 0.03 * sizeMultiplier;
          const logoCardRadius = canvas.width * 0.03 * sizeMultiplier;
          
          // Calculate dimensions
          const logoCardWidth = logoSize + (logoCardPadding * 2);
          const logoCardHeight = logoSize + (logoCardPadding * 2);
          
          // Vertical spacing between elements - adjusted for orientation
          const marginAfterLogo = canvas.width * 0.03 * sizeMultiplier; // Smaller margin for landscape
          const marginAfterTime = canvas.width * 0.005 * sizeMultiplier; // Smaller margin
          
          // Calculate heights for each section
          const timeBlockHeight = largeFontSize * 3; // Height of time text
          const locationBlockHeight = baseFontSize * 1.5; // Height of location text
          
          // Calculate total height from bottom to top
          const totalBottomHeight = locationBlockHeight + marginAfterTime + timeBlockHeight + marginAfterLogo + logoCardHeight;
          const bottomY = canvas.height - (padding * 0.8);
          
          // Reset shadow before drawing logo card
          ctx.shadowBlur = 0;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          
          // POSITION 1: Logo Perusahaan dalam Card Putih (PALING ATAS)
          const logoCardX = padding;
          const logoCardY = bottomY - totalBottomHeight; // Position at top of watermark area
          
          // Draw rounded white card background for logo with shadow
          ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
          ctx.shadowBlur = 15;
          ctx.shadowOffsetX = 5;
          ctx.shadowOffsetY = 5;
          ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
          
          // Draw rounded rectangle for logo card
          ctx.beginPath();
          ctx.moveTo(logoCardX + logoCardRadius, logoCardY);
          ctx.lineTo(logoCardX + logoCardWidth - logoCardRadius, logoCardY);
          ctx.quadraticCurveTo(logoCardX + logoCardWidth, logoCardY, logoCardX + logoCardWidth, logoCardY + logoCardRadius);
          ctx.lineTo(logoCardX + logoCardWidth, logoCardY + logoCardHeight - logoCardRadius);
          ctx.quadraticCurveTo(logoCardX + logoCardWidth, logoCardY + logoCardHeight, logoCardX + logoCardWidth - logoCardRadius, logoCardY + logoCardHeight);
          ctx.lineTo(logoCardX + logoCardRadius, logoCardY + logoCardHeight);
          ctx.quadraticCurveTo(logoCardX, logoCardY + logoCardHeight, logoCardX, logoCardY + logoCardHeight - logoCardRadius);
          ctx.lineTo(logoCardX, logoCardY + logoCardRadius);
          ctx.quadraticCurveTo(logoCardX, logoCardY, logoCardX + logoCardRadius, logoCardY);
          ctx.closePath();
          ctx.fill();
          
          // Reset shadow for logo drawing
          ctx.shadowBlur = 0;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          
          // Wait for company logo to load and draw it
          if (companyLogoLoaded && companyLogo.complete && companyLogo.naturalWidth > 0) {
            try {
              console.log('üé® Drawing company logo...');
              ctx.drawImage(
                companyLogo, 
                logoCardX + logoCardPadding, 
                logoCardY + logoCardPadding, 
                logoSize, 
                logoSize
              );
              console.log('‚úÖ Logo drawn successfully');
            } catch (logoError) {
              console.error('‚ùå Failed to draw logo:', logoError);
              // Fallback to emoji (3X larger)
              ctx.font = `bold ${logoSize * 0.7}px 'Bebas Neue', sans-serif`;
              ctx.fillStyle = '#ff8c00';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText('üè¢', logoCardX + logoCardWidth / 2, logoCardY + logoCardHeight / 2);
            }
          } else {
            console.warn('‚ö†Ô∏è Logo not loaded, using fallback emoji');
            // Fallback to emoji if logo is not loaded
            ctx.font = `bold ${logoSize * 0.7}px 'Bebas Neue', sans-serif`;
            ctx.fillStyle = '#ff8c00';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üè¢', logoCardX + logoCardWidth / 2, logoCardY + logoCardHeight / 2);
          }
          
          // Reset styles for text with better shadow
          ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
          ctx.shadowBlur = 12;
          ctx.shadowOffsetX = 4;
          ctx.shadowOffsetY = 4;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'bottom';
          
          const textStartX = padding;
          
          // POSITION 2: Jam (HH:MM) | Garis Kuning | Hari + Tanggal (DI BAWAH LOGO DENGAN JARAK 20px)
          const timeY = logoCardY + logoCardHeight + marginAfterLogo + timeBlockHeight;
          
          // Jam dengan Bebas Neue font (3X larger)
          ctx.font = `bold ${largeFontSize * 3}px 'Bebas Neue', sans-serif`;
          ctx.fillStyle = '#ffffff';
          ctx.fillText(timeString, textStartX, timeY);
          
          const timeWidth = ctx.measureText(timeString).width;
          
          // Garis vertikal kuning (THICKER - 3X) - tinggi sama dengan tinggi teks jam
          const separatorX = textStartX + timeWidth + (padding * 0.4);
          const separatorHeight = timeBlockHeight; // Same height as time text
          ctx.strokeStyle = '#facc15';
          ctx.lineWidth = 12; // Much thicker line
          ctx.beginPath();
          ctx.moveTo(separatorX, timeY - separatorHeight);
          ctx.lineTo(separatorX, timeY);
          ctx.stroke();
          
          // Hari (atas) dan Tanggal Lengkap (bawah) - sejajar dengan garis kuning
          const dateStartX = separatorX + (padding * 0.5);
          const dayDateSpacing = baseFontSize * 1.5; // Clear spacing between day and date
          
          // Hari - aligned with top of time text
          ctx.font = `700 ${baseFontSize * 1.3}px 'Poppins', sans-serif`;
          ctx.fillStyle = '#ffffff';
          ctx.fillText(dayName, dateStartX, timeY - dayDateSpacing);
          
          // Tanggal - aligned with bottom of time text
          ctx.font = `600 ${baseFontSize * 1.1}px 'Poppins', sans-serif`;
          ctx.fillText(dateString, dateStartX, timeY);
          
          // POSITION 3: Lokasi dengan ikon üìç (PALING BAWAH DENGAN JARAK 10px DARI JAM)
          const locationY = timeY + marginAfterTime + locationBlockHeight;
          ctx.font = `700 ${baseFontSize * 1.1}px 'Poppins', sans-serif`;
          const locationText = `üìç ${address}`;
          const maxLocationWidth = canvas.width * 0.55; // Limit width
          
          // Truncate address if too long
          let displayLocation = locationText;
          if (ctx.measureText(locationText).width > maxLocationWidth) {
            displayLocation = locationText.substring(0, 60) + '...';
          }
          
          ctx.fillStyle = '#ffffff';
          ctx.fillText(displayLocation, textStartX, locationY);
          
          // Reset shadow
          ctx.shadowBlur = 0;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 0;
          
          // Convert to high-quality data URL
          const watermarkedImage = canvas.toDataURL('image/jpeg', 0.95); // 95% quality
          resolve(watermarkedImage);
        };
        
        img.onerror = (error) => {
          console.error('‚ùå Failed to load image for watermark:', error);
          showToast('‚ùå Gagal memuat gambar');
          resolve(null);
        };
        
        img.src = imageDataUrl;
      });
    }

    // Render photo gallery
    function renderPhotoGallery() {
      const gallery = document.getElementById('photo-gallery');
      gallery.innerHTML = '';
      
      if (attendancePhotos.length === 0) {
        gallery.innerHTML = '<p class="col-span-full text-center text-gray-400 py-8">Belum ada foto. Klik "Ambil Foto" untuk memulai.</p>';
        return;
      }
      
      attendancePhotos.forEach((photo, index) => {
        const container = document.createElement('div');
        container.className = 'photo-thumbnail-container';
        
        const img = document.createElement('img');
        img.src = photo;
        img.alt = `Foto Absen ${index + 1}`;
        
        container.appendChild(img);
        container.addEventListener('click', () => openLightbox(index));
        
        gallery.appendChild(container);
      });
    }

    // Open lightbox
    function openLightbox(index) {
      currentLightboxIndex = index;
      const modal = document.getElementById('lightbox-modal');
      const img = document.getElementById('lightbox-image');
      
      img.src = attendancePhotos[currentLightboxIndex];
      modal.classList.add('active');
      
      // Show/hide navigation buttons
      updateLightboxNavigation();
    }

    // Close lightbox
    function closeLightbox() {
      const modal = document.getElementById('lightbox-modal');
      modal.classList.remove('active');
    }

    // Navigate lightbox
    function navigateLightbox(direction) {
      if (direction === 'next') {
        currentLightboxIndex = (currentLightboxIndex + 1) % attendancePhotos.length;
      } else {
        currentLightboxIndex = (currentLightboxIndex - 1 + attendancePhotos.length) % attendancePhotos.length;
      }
      
      const img = document.getElementById('lightbox-image');
      img.src = attendancePhotos[currentLightboxIndex];
      updateLightboxNavigation();
    }

    // Update lightbox navigation visibility
    function updateLightboxNavigation() {
      const prevBtn = document.getElementById('lightbox-prev');
      const nextBtn = document.getElementById('lightbox-next');
      
      if (attendancePhotos.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
      }
    }

    // Camera button handler
    document.getElementById('btn-ambil-foto').addEventListener('click', () => {
      if (attendancePhotos.length >= 10) {
        showToast('‚ùå Maksimal 10 foto sudah tercapai!');
        return;
      }
      
      showToast('üì∑ Membuka kamera...');
      document.getElementById('camera-input').click();
    });

    // Camera input handler
    document.getElementById('camera-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      
      if (!file) {
        console.log('‚ùå No file selected');
        showToast('‚ùå Tidak ada file yang dipilih');
        return;
      }
      
      console.log('‚úÖ File selected:', file.name, file.type, file.size);
      showToast('‚è≥ Memproses foto & menambahkan watermark...');
      
      try {
        const reader = new FileReader();
        
        reader.onload = async (event) => {
          try {
            console.log('üì∏ File loaded, size:', event.target.result.length);
            console.log('üñºÔ∏è Adding watermark...');
            
            const originalImage = event.target.result;
            
            // Add watermark
            const watermarkedImage = await addWatermarkToPhoto(originalImage);
            
            if (!watermarkedImage) {
              console.error('‚ùå Watermark returned null');
              showToast('‚ùå Gagal menambahkan watermark');
              return;
            }
            
            console.log('‚úÖ Watermark added successfully, size:', watermarkedImage.length);
            
            // Store photo
            attendancePhotos.push(watermarkedImage);
            console.log('üì¶ Total photos:', attendancePhotos.length);
            
            // Re-render gallery
            renderPhotoGallery();
            console.log('üé® Gallery rendered');
            
            showToast(`‚úÖ Foto ${attendancePhotos.length}/10 berhasil ditambahkan!`);
          } catch (innerError) {
            console.error('‚ùå Error in onload handler:', innerError);
            showToast('‚ùå Gagal menambahkan watermark: ' + innerError.message);
          }
        };
        
        reader.onerror = (error) => {
          console.error('‚ùå FileReader error:', error);
          showToast('‚ùå Gagal membaca file foto: ' + error);
        };
        
        console.log('üìñ Starting to read file...');
        reader.readAsDataURL(file);
        
      } catch (error) {
        console.error('‚ùå Error processing photo:', error);
        showToast('‚ùå Gagal memproses foto: ' + error.message);
      }
      
      // Reset input for multiple captures
      e.target.value = '';
    });

    // Lightbox event listeners
    document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
    document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox('prev'));
    document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox('next'));
    
    // Close lightbox on background click
    document.getElementById('lightbox-modal').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox-modal') {
        closeLightbox();
      }
    });

    // Keyboard navigation for lightbox
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('lightbox-modal');
      if (!modal.classList.contains('active')) return;
      
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        navigateLightbox('prev');
      } else if (e.key === 'ArrowRight') {
        navigateLightbox('next');
      }
    });

    // ========== KIRIM ABSEN FUNCTION ==========
    
    // Compress image to reduce file size while maintaining high resolution
    function compressImage(dataUrl, quality = 0.85) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = dataUrl;
      });
    }

    // Convert base64 to blob for better handling
    function base64ToBlob(base64) {
      const parts = base64.split(';base64,');
      const contentType = parts[0].split(':')[1];
      const raw = window.atob(parts[1]);
      const rawLength = raw.length;
      const uInt8Array = new Uint8Array(rawLength);
      
      for (let i = 0; i < rawLength; ++i) {
        uInt8Array[i] = raw.charCodeAt(i);
      }
      
      return new Blob([uInt8Array], { type: contentType });
    }

    // Download foto ke device (Android/Laptop) atau Share Sheet (iOS)
    async function downloadPhotos(photos) {
      try {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        if (isIOS && navigator.share) {
          // iOS: Gunakan Share Sheet
          try {
            const files = await Promise.all(photos.map(async (photo, index) => {
              const blob = base64ToBlob(photo);
              return new File([blob], `Absen_${index + 1}.jpg`, { type: 'image/jpeg' });
            }));
            
            await navigator.share({
              files: files,
              title: 'Foto Absensi',
              text: 'Simpan foto absensi'
            });
            
            showToast('‚úÖ Foto siap disimpan dari Share Sheet!');
          } catch (error) {
            console.warn('Share failed, trying direct download:', error);
            downloadPhotosDirectly(photos);
          }
        } else {
          // Android/Laptop: Download langsung
          downloadPhotosDirectly(photos);
        }
      } catch (error) {
        console.warn('Download blocked by browser:', error);
        showToast('‚ö†Ô∏è Download diblokir. Foto tetap tersimpan di Google Drive');
      }
    }

    // Download foto langsung ke device
    function downloadPhotosDirectly(photos) {
      try {
        photos.forEach((photo, index) => {
          const link = document.createElement('a');
          link.href = photo;
          link.download = `Absen_${index + 1}.jpg`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
        
        showToast(`‚úÖ ${photos.length} foto berhasil didownload!`);
      } catch (error) {
        console.warn('Direct download failed:', error);
        showToast('‚ö†Ô∏è Download diblokir. Foto tetap tersimpan di Google Drive');
      }
    }

    // Kirim absen ke Google Sheets & Drive
    async function kirimAbsen() {
      // Validasi: Harus ada minimal 1 pekerja yang dipilih
      if (Object.keys(selectedCards).length === 0) {
        showToast('‚ùå Pilih minimal 1 pekerja terlebih dahulu!');
        return;
      }
      
      const statusDiv = document.getElementById('send-status');
      statusDiv.className = 'mt-4 p-4 rounded-lg bg-blue-500/20 border border-blue-500';
      statusDiv.innerHTML = '<p class="text-blue-400 font-semibold">‚è≥ Mengirim data absensi...</p>';
      statusDiv.classList.remove('hidden');
      
      try {
        // Prepare attendance data
        const now = new Date();
        const tanggal = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
        const jam = `${String(now.getHours()).padStart(2, '0')}.${String(now.getMinutes()).padStart(2, '0')}.${String(now.getSeconds()).padStart(2, '0')}`;
        
        // Build worker status data
        const workerStatuses = workers.map(worker => {
          const status = selectedCards[worker.id];
          let statusText = 'Belum absen';
          let color = 'red';
          
          if (status === 'start') {
            statusText = 'Start Work';
            color = 'green';
          } else if (status === 'finish') {
            statusText = 'Finish Work';
            color = 'blue';
          } else if (status === 'break') {
            statusText = 'Istirahat';
            color = 'orange';
          } else if (status === 'resume') {
            statusText = 'Standby';
            color = 'purple';
          }
          
          return {
            name: worker.name,
            status: statusText,
            color: color
          };
        });
        
        // Compress photos
        statusDiv.innerHTML = '<p class="text-blue-400 font-semibold">‚è≥ Mengkompresi foto...</p>';
        const compressedPhotos = await Promise.all(
          attendancePhotos.map(photo => compressImage(photo, 0.85))
        );
        
        // Prepare data for Apps Script
        const requestData = {
          tanggal: tanggal,
          jam: jam,
          workers: workerStatuses,
          photos: compressedPhotos
        };
        
        statusDiv.innerHTML = '<p class="text-blue-400 font-semibold">‚è≥ Mengirim ke server...</p>';
        
        // Send to Apps Script (parallel processing)
        const sendPromise = fetch(`${appsScriptUrl}?action=submitAttendance`, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });
        
        // Download photos to device (parallel)
        const downloadPromise = downloadPhotos(attendancePhotos);
        
        // Wait for both operations
        await Promise.all([sendPromise, downloadPromise]);
        
        // Note: With no-cors, we can't read the response, so we assume success
        statusDiv.className = 'mt-4 p-4 rounded-lg bg-green-500/20 border border-green-500';
        statusDiv.innerHTML = `
          <p class="text-green-400 font-semibold mb-2">‚úÖ Absensi berhasil dikirim!</p>
          <p class="text-sm text-gray-300">Data: ${workerStatuses.length} pekerja</p>
          <p class="text-sm text-gray-300">Foto: ${attendancePhotos.length} foto</p>
        `;
        
        showToast('‚úÖ Absensi berhasil dikirim!');
        
        // Auto-hide status after 5 seconds
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 5000);
        
      } catch (error) {
        console.error('Error sending attendance:', error);
        statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-500/20 border border-red-500';
        statusDiv.innerHTML = `
          <p class="text-red-400 font-semibold mb-2">‚ùå Gagal mengirim absensi!</p>
          <p class="text-sm text-gray-300">${error.message}</p>
        `;
        
        showToast('‚ùå Gagal mengirim absensi');
      }
    }

    // Event listener untuk tombol Kirim Absen
    document.getElementById('btn-kirim-absen').addEventListener('click', kirimAbsen);

    // Element SDK Implementation
    async function onConfigChange(config) {
      document.getElementById('header-title').textContent = config.app_title || defaultConfig.app_title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['login_username', config.login_username || defaultConfig.login_username],
        ['login_password', config.login_password || defaultConfig.login_password]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9baa33b2b0971edc',t:'MTc2Nzg1OTY1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
